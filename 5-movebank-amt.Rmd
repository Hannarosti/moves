---
title: "test"
author: "stolen from John Fieberg"
date: "9/23/2020"
output:
  bookdown::html_document2:
    css: style.css
    number_sections: false
    theme: default
    highlight: haddock
    toc: true
    toc_float: true
bibliography: moves.bib
csl: ecology.csl
---

```{r, echo=FALSE}
library(knitr)
library(bookdown)
options(figure_counter = FALSE, digits = 2, width = 150)
opts_knit$set(eval.after='fig.cap')
knitr::opts_chunk$set(tidy.opts=list(width.cutoff=60), 
                      echo=TRUE, 
                      warning=FALSE, 
                      message=FALSE, 
                      fig.width=12, fig.height=4.5)
```

This material has been "borrowed" (and modified) from a [Movebank workshop](https://movebankworkshopraleighnc.netlify.app/index.html), led by [John Fieberg](https://fieberg-lab.cfans.umn.edu/people/john-fieberg).

## Purpose

- Retrieve and explore animal movement data from Movebank
- Illustrate how to work with functions in the animal movement tools package (`amt`)
- Write out available points for further annotating in `EnvDATA` 

#### Preamble

Load libraries
```{r}
library(lubridate)
library(maptools)
library(raster)
library(move)
library(amt) 
library(ggmap)
library(tibble)
library(leaflet)
library(dplyr)
library(tidyr)
library(lwgeom)
library(readr)
library(here)
nest <- nest_legacy
unnest <- unnest_legacy
```

Set the seed for the random number generator, so it will be possible to reproduce the random points
```{r}
set.seed(10299)
```

Create a login object for a user account at [movebank.org]
```{r}
loginStored <- movebankLogin(username = "MovebankWorkshop", 
                             password = "genericuserforthisexercise")
```

Get overview information about a Movebank study. Be sure to check the citation and license terms if not using your own data.

```{r}
getMovebankStudy(study = "Martes pennanti LaPoint New York", login=loginStored) 

```

You may receive a message that you do not have access to data in a study. If you are not a data manager for a study, the owner may require that you read and accept the license terms once before you may download it. Currently license terms cannot be accepted directly from the `move` package. To view and accept them, go to movebank.org, search for the study and begin a download, and view and accept the license terms. After that you will be able to load from `R`.

Load data from a study in Movebank and create a `MoveStack` object. For more details and options see [https://cran.r-project.org/web/packages/move/index.html].

```{r}
fisher.move <- getMovebankData(study = "Martes pennanti LaPoint New York", 
                               login = loginStored)
head(fisher.move)
```

Note: If there are duplicate animal-timestamp records in Movebank, you will get a warning. You can exclude duplicate records on import using `removeDuplicatedTimestamps = TRUE`. If you are a data manager for a study in Movebank you can also filter them out directly in the study so they are excluded by default in downloads see [https://www.movebank.org/node/27252].

Create a data frame from the `MoveStack` object
```{r}
fisher.dat <- as(fisher.move, "data.frame")
```

### Data cleaning

Delete observations where missing lat or long or a timestamp.  There are no missing
observations in this data set, but it is still good practice to check.
```{r}
ind <- complete.cases(fisher.dat[, c("location_lat", "location_long", "timestamp")])
fisher.dat <- fisher.dat[ind == TRUE, ]
```

Check for duplicated observations (ones with same lat, long, timestamp, and individual identifier). There are no duplicate observations in this data set, but it is still good practice to check.
```{r}
ind2 <- fisher.dat %>% 
  select(timestamp, location_long, location_lat, local_identifier) %>%
  duplicated

sum(ind2) # no duplicates
fisher.dat <- fisher.dat[ind2 != TRUE, ]
```

Make `timestamp` a date/time variable
```{r}
fisher.dat$timestamp <- as.POSIXct(fisher.dat$timestamp, 
                                   format = "%Y-%m-%d %H:%M:%OS", tz = "UTC")
```

The `move` package has simple functions to `plot` movement data, to `show` the contents of the `MoveStack` object, and to make a `summary` of its contents:
```{r}
plot(fisher.move)
show(fisher.move)
summary(fisher.move)
```

## Plots of the data

There are lots of ways to plot data using `R`. We are going to use `leaflet`. Let's look at the data from individual `F2`. 

When reading data from Movebank always be sure to refer to the animal-id and individual-local-identifer and not the tag-id or tag-local-identifier in order to exclude pre- and post-deployment records and correctly separate out individual animals when the study includes redeployments.

```{r}
fisherF2 <- fisher.dat %>% filter(local_identifier == "F2")

leaflet(fisherF2) %>% 
  addTiles() %>%
  addCircles(fisherF2$location_long, fisherF2$location_lat)
```

### Using `ggplot` without a background
 
Use separate axes for each individual (add `scales = "free"` to `facet_wrap`)

```{r, fig.height=12, fig.width=12}
ggplot(fisher.dat, aes(x = location_long, y = location_lat)) + 
  geom_point(size = 0.7, alpha = 0.2) +
  facet_wrap(~local_identifier, scales = "free")
```

Now, all animals on 1 plot

```{r, fig.height=6, fig.width=12}
ggplot(fisher.dat, aes(x = location_long, y = location_lat, 
                       color = as.factor(local_identifier))) +
  geom_point(size = 0.7, alpha = 0.2) +
  coord_fixed()
```

# Creating a track with `amt`

Before we can use the `amt` package to calculate step lengths, turn angles, and bearings for fisher data, we need to add a class (`track`) to the data. Then, we can summarize the data by individual, month, etc.

The fisher data has lat lon coordinates, so we use:
```{r}
trk <- mk_track(fisher.dat, 
                .x = location_long, 
                .y = location_lat,
                .t = timestamp, 
                id = local_identifier, 
                crs = CRS("+init=epsg:4326"))
```
Note that we have used `crs = CRS("+init = epsg:4326")` to say that the spatial coordinates are projected in lat lon.

Now, we can transform back to UTM coordinates:
```{r}
trk <- transform_coords(trk, CRS("+init=epsg:32618"))
```
Note that for a different dataset, we will have to figure out which projection works for our data.

Now it is easy to calculate day/night with either movement track
```{r}
trk <- trk %>% time_of_day()
```

Save the class here (and apply it later after adding columns to the object)
```{r}
trk.class <- class(trk)
```

## Movement Characteristics

The `amt` package has some useful functions:

- `direction_abs` will calculate absolute angles for steps
- `direction_rel` will calculate turning angles (relative angles)
- `step_lengths` will calculate distances between points
- `nsd` = Net Squared Displacement (squared distance from first point)

Arguments for `direction_abs`:
- `full_circle` (`TRUE` or  `FALSE`) will calculate between $0$ and $2 \pi$ (rather than $-\pi$ and $\pi$)
- `zero_dir` (character `N`, `E`, `S`, `W`) gives the direction = $0$ for absolute angle

Note:  we have to calculate these characteristics separately for each individual (to avoid calculating a distance between say the last observation of the first individual and the first observation of the second individual).

To do this, we could loop through individuals, calculate these characteristics for each individual, then `rbind` the data back together. Or, use nested data frames and the map function in the `purrr` package to do this with very little code.

To see how nesting works, we can create a nested object by individual

```{r}
nesttrk <- trk %>% 
  group_by(id) %>% 
  nest()
nesttrk
```

Each row contains data from an individual. For example, we can access data from the first individual using:

```{r}
nesttrk$data[[1]]
```

We could calculate movement characteristics by individual using:

```{r}
tmp <- direction_rel(nesttrk$data[[1]])
head(tmp)
```

or:
```{r}
tmp <- trk %>% 
  filter(id=="M1") %>% 
  direction_rel
head(tmp)
```

Or, we can add a columns to each nested column of data using `purrr::map`
```{r}
trk1 <- trk %>% 
  group_by(id) %>% 
  nest() %>% 
  mutate(dir_abs = map(data, 
                       direction_abs, 
                       full_circle = TRUE, 
                       zero_dir = "N", 
                       clockwise = TRUE), 
         dir_rel = map(data, direction_rel), 
         sl = map(data, step_lengths),
         nsd_ = map(data, nsd)) %>% 
  unnest()
trk1
```

Now, calculate month, year, hour, week of each observation and append these to the dataset. Unlike the movement charactersitics, these calculations can be done all at once, since they do not utilize successive observations (like step lengths and turn angles do).

```{r}
trk1 <- trk1 %>% 
  mutate(
    week = week(t_),
    month = month(t_, label=TRUE), 
    year = year(t_),
    hour = hour(t_)
  )
```

## Some plots of movement characteristics

### Absolute angles (movement direction for each step) relative to North

We could use a rose diagram (below) to depict the distribution of angles. 
```{r, fig.height=12, fig.width=12}
ggplot(trk1, aes(x = dir_abs, y = ..density..)) + 
  geom_histogram(breaks = seq(0, 2 * pi, len = 30)) +
  coord_polar(start = 0) + theme_minimal() + 
  scale_fill_brewer() + 
  labs(y = "Density", title = "Movement direction") + 
  scale_x_continuous(limits = c(0, 2 * pi), 
                     breaks = c(0, pi/2, pi, 3 * pi/2), 
                     labels = c("0","", "pi","")) +
  facet_wrap( ~ id)
```

### Turning angles 

Note: a $0$ indicates the animal continued to move in the same direction, a $\pi$ indicates the animal turned around (but note, resting + measurement error often can make it look like the animal has turned around).

```{r, fig.height=12, fig.width=12}
ggplot(trk1, aes(x = dir_rel, y = ..density..)) + 
  geom_histogram(breaks = seq(-pi, pi, length = 20))+
  coord_polar(start = 0) + theme_minimal() +
  scale_fill_brewer() + 
  ylab("Density") + ggtitle("Turning angle") + 
  scale_x_continuous(limits = c(-pi, pi), 
                     breaks = c(-pi, -pi/2, 0, pi/2, pi), 
                     labels = c("-pi", "", "0", "", "pi")) +
  facet_wrap(~id)
```

### Net-squared displacement over time for each individual

```{r, fig.height=12, fig.width=12}
ggplot(trk1, aes(x = t_, y = nsd_)) + 
  geom_path() +
  facet_wrap(~id, scales = "free")
```

## Explore movement characteristics by (day/night, hour, month)
### step length distribution by day/night
```{r, fig.height=12, fig.width=12, warning=FALSE, message=FALSE}

ggplot(trk1, aes(x = tod_, y = log(sl))) + 
  geom_boxplot() + 
  geom_smooth() + 
  facet_wrap(~id)
```

### Space use (MCP or KDE) by week, month, and year

Note:  this code will only work for your critters if you have multiple observations for each combination of (month, year). If you don't have many observations, you could try:  `group_by(id, year)`.

```{r, fig.height=12, fig.width=12, warning=FALSE, message=FALSE}
mcps.week <- trk %>% 
  mutate(year = year(t_), month = month(t_), week = week(t_)) %>% 
  group_by(id, year, month, week) %>% nest() %>% 
  mutate(mcparea = map(data, ~ hr_mcp(., levels = c(0.95)) %>% 
                         hr_area)) %>% 
  select(id, year, month, week, mcparea) %>% 
  unnest()

ggplot(mcps.week, aes(x = week, y = area, colour = factor(year))) + 
  geom_point() +
  geom_smooth() + 
  facet_wrap(~id, scales="free")
```

<!-- Same for KDE -->
<!-- ```{r, fig.height=12, fig.width=12, warning=FALSE, message=FALSE} -->

<!-- kde.week <- trk %>%  -->
<!--   mutate(year = year(t_), month = month(t_), week = week(t_)) %>%  -->
<!--   group_by(id, year, month, week) %>% nest() %>%  -->
<!--   mutate(kdearea = map(data, ~ hr_kde(., levels=c(0.95)) %>% hr_area)) %>% -->
<!--   select(id, year, month, week,  kdearea) %>% unnest() -->

<!-- ggplot(kde.week, aes(x = week, y = kdearea, colour = factor(year))) +  -->
<!--   geom_point() + -->
<!--   geom_smooth() + facet_wrap(~id, scales = "free") -->
<!-- ``` -->

Write out files for later analyses
```{r}
write_rds(trk, path = here("data","trk.Rdata"))
write_rds(fisher.dat, path = here("data","fisher.Rdata"))
```

# Investigate step length and turning angle distributions further

We will use only one animal to illustrate these approaches, but it could be easily extended to multiple animals using the same strategies as above.

## Different habitats
```{r}
dat <- trk %>% filter(id == "F1")
```

We first have to make sure that the sampling rate is constant. Otherwise step length and turning angles can not be compared. Let's check what the current sampling rate is:
```{r}
summarize_sampling_rate(dat)
```

10 minutes seems to be appropriate. We can resample our track to a 10 min sampling rate with a tolerance of 1 minute.

```{r}

dat <- track_resample(dat, 
                      rate = minutes(10), 
                      tolerance = minutes(1)) %>% 
  filter_min_n_burst(min_n = 3)

```

`dat` gained a new column: `burst_`. This column indicates for each point to which burst it belongs. A burst is a sequence of relocations with equidstant (in time) relocations.

```{r}
steps <- dat %>% steps_by_burst() 

steps %>% ggplot(aes(sl_)) + 
  geom_histogram()
```

Let us add to each step the habitat type where it started. 

It might be good to group some of the categories. 
1 = 21, 22, 23: Developed
4 = 90: Wetland

```{r}
data("amt_fisher_lu")
lu <- amt_fisher_lu %in% c(41:43, 90)
plot(lu)

steps %>% extract_covariates(lu, where = "start") %>% 
  ggplot(aes(sl_)) + 
  geom_histogram() + 
  facet_wrap(~ layer)

steps %>% extract_covariates(lu, where = "both") %>% 
  mutate(where = case_when(
    layer_start == 1 & layer_end == 1 ~ "in forest", 
    layer_start == 0 & layer_end == 0 ~ "in other", 
    layer_start != layer_end ~ "transistion")) %>% 
  ggplot(aes(sl_)) + geom_density() + 
  facet_wrap(~ where)
```

## Look at step and turning angles for long and short steps
 
We first need to split steps into long and short steps and therefore determine a threshold. 
```{r}
steps %>% ggplot(aes(sl_)) + 
  geom_histogram() + 
  geom_vline(xintercept = 120, col = "red")
```

$120$ m seems to be a reasonabLe cutoff.
```{r}
steps %>% 
  mutate(step_length = case_when(sl_ > 120 ~ "long", TRUE ~ "short")) %>% 
ggplot(aes(x = ta_, y = ..density..)) + 
  geom_histogram(breaks = seq(-pi, pi, length = 20))+
  coord_polar(start = 0) + 
  theme_minimal() +
  scale_fill_brewer() + 
  ylab("Density") + 
  ggtitle("Angles Direct") + 
  scale_x_continuous(limits = c(-pi, pi), breaks = c(-pi, -pi/2, 0, pi/2, pi), 
                     labels = c("-pi", "-pi/2", "0", "pi/2", "pi")) +
  facet_wrap(~ step_length)

```

We can see that longer steps tend to be more directed (with turning angles near $0$), and that short steps often have turn angles near -$\pi$ or $\pi$. Some of these angles associated with small steps are likely due to measurement error. 

Here is another plot of turning angles for short and long steps.
```{r}
steps %>% 
  mutate(step_length = case_when(sl_ > 120 ~ "long", TRUE ~ "short")) %>% 
ggplot(aes(x = ta_, y = ..density..)) + 
  geom_histogram(breaks = seq(-pi, pi, length = 20))+
  scale_x_continuous(limits = c(-pi, pi), breaks = c(-pi, -pi/2, 0, pi/2, pi), 
                     labels = c("-pi", "-pi/2", "0", "pi/2", "pi")) +
  facet_wrap(~ step_length)

```
